
# ABOUT THIS TEMPLATE
#
# If this is the template file, copy it to a new file called "Makefile" and
# edit the FOREM_* vaules in the below build-forem-selfhost target to reflect
# your own values.
#
# For example, if your site is going to be at the domain "talk.example.com"
# and the email address you want to use is "admin@example.com", you'd set
# the config as follows:
#
#
#   ...
#   --build-arg "FOREM_DOMAIN_NAME=example.com" \
#	--build-arg "FOREM_SUBDOMAIN_NAME=talk" \
#	--build-arg "FOREM_DEFAULT_EMAIL=admin@example.com" \
#   ...
#
# Note that FOREM_SUBDOMAIN_NAME can be left blank if you're not using a
# subdomain, e.g.: codechatz.com

# ABOUT THIS MAKEFILE
#
# The "target"s in this file are intended to be executed using an application
# called "make" which you may have installed.
# For example, to build the base Docker image, you'd execute:
#
#  make build-forem-selfhost
#
# If you don't have or don't want to use make, you can simply execute the
# commands yourself, e.g.:
#   docker build ... --build-arg "FOREM_DEFAULT_EMAIL=" . -t forem-selfhost


###############################################################################
# Build the base / platform-agnostic Docker image
###############################################################################

build-forem-selfhost:
	@docker build \
	--build-arg "DOCKER_USER=`id -un`" \
	--build-arg "DOCKER_UID=`id -u`" \
	--build-arg "DOCKER_GID=`id -g`" \
	--build-arg "FOREM_DOMAIN_NAME=" \
	--build-arg "FOREM_SUBDOMAIN_NAME=" \
	--build-arg "FOREM_DEFAULT_EMAIL=" \
	. \
	-t forem-selfhost


###############################################################################
# Build the DigitalOcean deployment Docker image
#
# Create a file in this directory called ".digitalocean-access-token"
# that contains your Personal Access Token.
#
# https://docs.digitalocean.com/reference/api/create-personal-access-token/
#
###############################################################################

build-forem-selfhost-digitalocean:
	@DOCKER_BUILDKIT=1 docker build \
	-f Dockerfile-digitalocean . \
	--secret id=digitalocean-access-token,src=.digitalocean-access-token \
	-t forem-selfhost-digitalocean


###############################################################################
# Deploy to DigitalOcean
###############################################################################

deploy-to-digitalocean:
	@docker run forem-selfhost-digitalocean
